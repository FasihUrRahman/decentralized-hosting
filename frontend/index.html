<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Decentralized Hosting</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 2em; background-color: #f8f9fa; color: #343a40; }
        .container { max-width: 800px; margin: auto; background: white; padding: 2em; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #007bff; }
        .upload-form { display: flex; flex-direction: column; gap: 1.5em; margin-bottom: 2em;}
        input[type="file"] { border: 1px solid #ced4da; padding: 0.5em; border-radius: 4px; }
        button { padding: 0.8em; font-size: 1em; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.2s; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        .status, .file-list, .leaderboard { margin-top: 1.5em; padding: 1em; border-radius: 4px; background-color: #e9ecef; }
        h2 { margin-top: 0; border-bottom: 2px solid #ced4da; padding-bottom: 0.5em;}
        pre { white-space: pre-wrap; word-wrap: break-word; background: #343a40; color: #f8f9fa; padding: 1em; border-radius: 4px; }
        ul { list-style-type: none; padding: 0; }
        li { background: #f8f9fa; margin-bottom: 0.5em; padding: 0.75em; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
        li a { text-decoration: none; color: #007bff; font-weight: 500; }
        li a:hover { text-decoration: underline; }
        .delete-btn { background-color: #dc3545; padding: 0.4em 0.8em; font-size: 0.9em; }
        .delete-btn:hover { background-color: #c82333; }
        table { width: 100%; border-collapse: collapse; margin-top: 1em; }
        th, td { text-align: left; padding: 0.75em; border-bottom: 1px solid #dee2e6; }
        th { background-color: #007bff; color: white; }
        tr:nth-child(even) { background-color: #f8f9fa; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Decentralized File Hosting</h1>
        
        <form id="uploadForm" class="upload-form">
            <h2>Upload a New File</h2>
            <input type="file" id="fileInput" required>
            <button type="submit" id="uploadButton">Upload File</button>
        </form>

        <div id="status" class="status" style="display:none;">
            <h2 id="statusTitle"></h2>
            <pre id="statusBody"></pre>
        </div>

        <div class="file-list">
            <h2>Uploaded Files</h2>
            <ul id="fileList"></ul>
        </div>

        <div class="leaderboard">
            <h2>Peer Leaderboard</h2>
            <table>
                <thead>
                    <tr>
                        <th>Peer ID</th>
                        <th>Successful Audits</th>
                        <th>Failed Audits</th>
                        <th>Tokens Earned</th>
                    </tr>
                </thead>
                <tbody id="leaderboardBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        const uploadForm = document.getElementById('uploadForm');
        const fileInput = document.getElementById('fileInput');
        const uploadButton = document.getElementById('uploadButton');
        const statusDiv = document.getElementById('status');
        const statusTitle = document.getElementById('statusTitle');
        const statusBody = document.getElementById('statusBody');
        const fileList = document.getElementById('fileList');
        const leaderboardBody = document.getElementById('leaderboardBody');
        const apiUrl = 'http://localhost:8080';

        const renderFileList = () => {
            const storedFiles = JSON.parse(localStorage.getItem('uploadedFiles') || '[]');
            fileList.innerHTML = '';
            if (storedFiles.length === 0) {
                fileList.innerHTML = '<li>No files uploaded yet.</li>';
                return;
            }
            storedFiles.forEach(fileData => {
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.href = `${apiUrl}/download/${fileData.file_id}`;
                a.textContent = fileData.original_filename;
                a.target = '_blank';
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Delete';
                deleteBtn.className = 'delete-btn';
                deleteBtn.onclick = () => handleDelete(fileData.file_id, fileData.original_filename);
                li.appendChild(a);
                li.appendChild(deleteBtn);
                fileList.appendChild(li);
            });
        };

        /**
         * Fetches ledger data and renders the leaderboard, now with rewards.
         */
        const fetchAndRenderLedger = async () => {
            try {
                const response = await fetch(`${apiUrl}/network/ledger`);
                const ledger = await response.json();
                leaderboardBody.innerHTML = '';

                const peers = Object.keys(ledger);
                if (peers.length === 0) {
                    leaderboardBody.innerHTML = '<tr><td colspan="4">No peer data available yet. Waiting for audits...</td></tr>';
                    return;
                }

                for (const peerId in ledger) {
                    const data = ledger[peerId];
                    const successes = data.successful_audits || 0;
                    const failures = data.failed_audits || 0;
                    const tokensIssued = data.tokens_issued || 0;

                    // --- NEW: More robust reward calculation ---
                    const score = (successes * 10) - (failures * 25);
                    let totalTokensEligible = 0;
                    if (score > 0) {
                        totalTokensEligible = Math.floor(score / 100);
                    }
                    
                    // The tokens shown are the total they are eligible for
                    const tokensToShow = totalTokensEligible;

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${peerId}</td>
                        <td>${successes}</td>
                        <td>${failures}</td>
                        <td>${tokensToShow} ðŸª™</td>
                    `;
                    leaderboardBody.appendChild(row);
                }
            } catch (error) {
                leaderboardBody.innerHTML = '<tr><td colspan="4">Error loading leaderboard data.</td></tr>';
                console.error("Error fetching ledger:", error);
            }
        };

        const addFileToList = (fileData) => {
            const storedFiles = JSON.parse(localStorage.getItem('uploadedFiles') || '[]');
            if (!storedFiles.some(f => f.file_id === fileData.file_id)) {
                storedFiles.push(fileData);
            }
            localStorage.setItem('uploadedFiles', JSON.stringify(storedFiles));
            renderFileList();
        };

        const removeFileFromList = (fileId) => {
            let storedFiles = JSON.parse(localStorage.getItem('uploadedFiles') || '[]');
            storedFiles = storedFiles.filter(f => f.file_id !== fileId);
            localStorage.setItem('uploadedFiles', JSON.stringify(storedFiles));
            renderFileList();
        };

        const handleDelete = async (fileId, filename) => {
            if (!confirm(`Are you sure you want to permanently delete '${filename}'?`)) return;
            statusDiv.style.display = 'block';
            statusTitle.textContent = 'Deleting...';
            statusBody.textContent = `Requesting deletion of ${filename}...`;
            try {
                const response = await fetch(`${apiUrl}/delete/${fileId}`, { method: 'DELETE' });
                const result = await response.json();
                if (!response.ok) { throw new Error(result.detail || 'Server error'); }
                statusTitle.textContent = 'âœ… Deletion Initiated';
                statusBody.textContent = JSON.stringify(result, null, 2);
                removeFileFromList(fileId);
            } catch (error) {
                statusTitle.textContent = 'âŒ Deletion Failed';
                statusBody.textContent = `An error occurred: ${error.message}`;
            }
        };
        
        const handleUpload = async (e) => {
            e.preventDefault();
            if (!fileInput.files.length) { return; }
            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('file', file);
            uploadButton.disabled = true;
            uploadButton.textContent = 'Uploading...';
            statusDiv.style.display = 'block';
            statusTitle.textContent = 'Uploading...';
            statusBody.textContent = `Sending ${file.name}...`;
            try {
                const response = await fetch(`${apiUrl}/upload/`, { method: 'POST', body: formData });
                const result = await response.json();
                if (!response.ok) { throw new Error(result.detail || `Server error`); }
                statusTitle.textContent = 'âœ… Upload Complete!';
                statusBody.textContent = JSON.stringify(result, null, 2);
                addFileToList({ original_filename: result.original_filename, file_id: result.file_id });
            } catch (error) {
                statusTitle.textContent = 'âŒ Upload Failed';
                statusBody.textContent = `An error occurred: ${error.message}`;
            } finally {
                uploadButton.disabled = false;
                uploadButton.textContent = 'Upload File';
                fileInput.value = '';
            }
        };

        uploadForm.addEventListener('submit', handleUpload);
        document.addEventListener('DOMContentLoaded', () => {
            renderFileList();
            fetchAndRenderLedger();
            setInterval(fetchAndRenderLedger, 5000);
        });
    </script>
</body>
</html>