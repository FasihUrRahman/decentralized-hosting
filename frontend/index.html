<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Decentralized Hosting</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 2em; background-color: #f8f9fa; color: #343a40; }
        .container { max-width: 800px; margin: auto; background: white; padding: 2em; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #007bff; }
        .upload-form { display: flex; flex-direction: column; gap: 1.5em; margin-bottom: 2em;}
        input[type="file"] { border: 1px solid #ced4da; padding: 0.5em; border-radius: 4px; }
        button { padding: 0.8em; font-size: 1em; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.2s; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        .status, .file-list { margin-top: 1.5em; padding: 1em; border-radius: 4px; background-color: #e9ecef; }
        h2 { margin-top: 0; border-bottom: 2px solid #ced4da; padding-bottom: 0.5em;}
        pre { white-space: pre-wrap; word-wrap: break-word; background: #343a40; color: #f8f9fa; padding: 1em; border-radius: 4px; }
        ul { list-style-type: none; padding: 0; }
        li { background: #f8f9fa; margin-bottom: 0.5em; padding: 0.75em; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
        li a { text-decoration: none; color: #007bff; font-weight: 500; }
        li a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Decentralized File Hosting</h1>
        
        <form id="uploadForm" class="upload-form">
            <h2>Upload a New File</h2>
            <label for="fileInput">Choose a file to upload:</label>
            <input type="file" id="fileInput" required>
            <button type="submit" id="uploadButton">Upload File</button>
        </form>

        <div id="status" class="status" style="display:none;">
            <h2 id="statusTitle"></h2>
            <pre id="statusBody"></pre>
        </div>

        <div class="file-list">
            <h2>Uploaded Files</h2>
            <ul id="fileList">
                </ul>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const uploadForm = document.getElementById('uploadForm');
        const fileInput = document.getElementById('fileInput');
        const uploadButton = document.getElementById('uploadButton');
        const statusDiv = document.getElementById('status');
        const statusTitle = document.getElementById('statusTitle');
        const statusBody = document.getElementById('statusBody');
        const fileList = document.getElementById('fileList');

        // --- API Configuration ---
        const apiUrl = 'http://localhost:8080';

        /**
         * Renders the list of files from localStorage.
         * This function creates the clickable download links.
         */
        const renderFileList = () => {
            const storedFiles = JSON.parse(localStorage.getItem('uploadedFiles') || '[]');
            fileList.innerHTML = ''; // Clear the list first
            if (storedFiles.length === 0) {
                fileList.innerHTML = '<li>No files uploaded yet.</li>';
                return;
            }
            storedFiles.forEach(fileData => {
                const li = document.createElement('li');
                const a = document.createElement('a');
                // The link now correctly points to the download endpoint with the unique file_id
                a.href = `${apiUrl}/download/${fileData.file_id}`;
                a.textContent = fileData.original_filename;
                a.target = '_blank'; // Open in new tab to trigger download
                li.appendChild(a);
                fileList.appendChild(li);
            });
        };

        /**
         * Adds a new file's metadata to localStorage and re-renders the list.
         */
        const addFileToList = (fileData) => {
            const storedFiles = JSON.parse(localStorage.getItem('uploadedFiles') || '[]');
            // Prevent adding duplicates based on the unique file_id
            if (!storedFiles.some(f => f.file_id === fileData.file_id)) {
                storedFiles.push(fileData);
                localStorage.setItem('uploadedFiles', JSON.stringify(storedFiles));
            }
            renderFileList();
        };
        
        /**
         * Handles the form submission for file upload.
         */
        const handleUpload = async (e) => {
            e.preventDefault(); 
            if (!fileInput.files.length) {
                alert('Please select a file first!');
                return;
            }

            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('file', file);

            uploadButton.disabled = true;
            uploadButton.textContent = 'Uploading...';
            statusDiv.style.display = 'block';
            statusTitle.textContent = 'Uploading...';
            statusBody.textContent = `Sending ${file.name}...`;

            try {
                const response = await fetch(`${apiUrl}/upload/`, { method: 'POST', body: formData });
                const result = await response.json();

                if (!response.ok) { throw new Error(result.detail || `Server responded with status ${response.status}`); }
                
                statusTitle.textContent = '✅ Upload Complete!';
                statusBody.textContent = JSON.stringify(result, null, 2);
                // After a successful upload, add the file to our list using the data from the response
                addFileToList({ original_filename: result.original_filename, file_id: result.file_id });

            } catch (error) {
                statusTitle.textContent = '❌ Upload Failed';
                statusBody.textContent = `An error occurred: ${error.message}`;
            } finally {
                uploadButton.disabled = false;
                uploadButton.textContent = 'Upload File';
                fileInput.value = '';
            }
        };

        // --- Event Listeners ---
        uploadForm.addEventListener('submit', handleUpload);
        // Render the list from localStorage as soon as the page loads
        document.addEventListener('DOMContentLoaded', renderFileList);
    </script>
</body>
</html>